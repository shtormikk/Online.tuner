<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Онлайн тюнер</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #status { margin-bottom: 10px; }
    #note { font-size: 48px; font-weight: bold; }
    #frequency { font-size: 16px; color: #666; }
    #diagram {
      width: 100%; height: 150px; border: 1px solid #ccc; margin-top: 20px;
      display: grid; grid-template-columns: repeat(12, 1fr); align-items: end; gap: 2px;
      background: #f9f9f9;
    }
    .bar { width: 100%; background: #4caf50; height: 2px; transition: height 0.1s linear; }
  </style>
</head>
<body>
  <h1>Онлайн тюнер</h1>
  <div id="status">Подключение к микрофону...</div>

  <div id="note" aria-live="polite">—</div>
  <div id="frequency">Частота: — Гц</div>

  <div id="diagram" aria-label="Ближайшая нота диаграмма">
    <!-- 12 столбиков диаграммы -->
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
    <div class="bar" style="height: 6px"></div>
  </div>

  <button id="startBtn">Начать сканирование</button>

  <script>
    // Частоты нот (для 12-тоновый хроматический якорь)
    // Нота A4 = 440 Гц. Можно расширить до более точной идентификации по октавам.
    const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

    function freqToNoteInfo(freq) {
      // Преобразование частоты в ближайшую ноту (таблица MIDI)
      // MIDI нота 69 = A4 = 440 Гц
      if (!freq || freq <= 0) return null;
      const midi = 12 * (Math.log2(freq / 440)) + 69;
      const midiRounded = Math.round(midi);
      const noteIndex = (midiRounded + 12) % 12;
      const octave = Math.floor(midiRounded / 12) - 1;
      const noteName = noteNames[noteIndex] + octave;
      const freqSorted = 440 * Math.pow(2, (midiRounded - 69) / 12);
      const detune = Math.round((freq - freqSorted)); // зачем? можно использовать cents
      const cents = Math.round(1200 * Math.log2(freq / freqSorted));
      return { noteName, freq: freqSorted, midi: midiRounded, cents };
    }

    let audioCtx;
    let analyser;
    let dataArray;
    let isRunning = false;

    const statusEl = document.getElementById("status");
    const noteEl = document.getElementById("note");
    const freqEl = document.getElementById("frequency");
    const bars = document.querySelectorAll("#diagram .bar");
    const startBtn = document.getElementById("startBtn");

    async function startScanner() {
      if (isRunning) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);
        isRunning = true;
        statusEl.textContent = "Сканирование активировано. Приближайте устройство к источнику звука.";
        renderLoop();
      } catch (e) {
        statusEl.textContent = "Не удалось получить доступ к микрофону: " + e.message;
      }
    }

    // Простая асинхронная петля анализа частоты
    function getRoughFrequency() {
      // Мы используем простую схему: применяемogy автокорреляцию или спектральный метод.
      // Простой подход: вычислить максимум спектра ближе к основному пику.
      analyser.getByteFrequencyData(dataArray);
      // Идея: выбрать частоту с максимальной амплитудой в диапазоне 80-1000 Гц (для гитары).
      const sampleRate = audioCtx.sampleRate;
      const nyquist = sampleRate / 2;
      const minHz = 70;
      const maxHz = 1000;
      const minIndex = Math.floor(minHz / nyquist * dataArray.length);
      const maxIndex = Math.floor(maxHz / nyquist * dataArray.length);

      let maxVal = 0;
      let maxIndexFound = -1;
      for (let i = minIndex; i <= maxIndex; i++) {
        if (dataArray[i] > maxVal) {
          maxVal = dataArray[i];
          maxIndexFound = i;
        }
      }
      if (maxIndexFound <= 0) return null;

      const freq = maxIndexFound * nyquist / dataArray.length;
      // Уменьшение ложных пиков: если амплитуда слишком мала, вернуть null
      if (maxVal < 20) return null;
      return freq;
    }

    function updateDiagram(freq) {
      // Отобразим ближайшую ноту по высоте столбиков: простой визуальный индикатор
      // Преобразуем частоту в смещение по нотам относительно A4
      const target = freq ? freqToNoteInfo(freq) : null;
      // Подсветим столбик: найдём ближнюю ноту (0..11) по октавам фиктивно
      // Простой способ: высоту столбика пропорционально близости к частоте близкой к A4 (440 Hz)
      const heightBase = 6; // минимальная высота
      const maxHeight = 140;
      // Если freq известна, вычислим расстояние в центах от A4
      let height = heightBase;
      if (freq && target) {
        const centFromA4 = 1200 * Math.log2(freq / 440);
        // нормируем: каждые 100 центов добавляют примерно 10px
        height = Math.min(maxHeight, heightBase + Math.abs(centFromA4) * 0.5);
      }
      bars.forEach((b, i) => {
        // распределим высоту по индексу, чтобы создать волну вокруг ближайшей ноты
        const offset = Math.abs(i - 6); // центр near A4 в середине
        const h = Math.max(2, height - offset * 4);
        b.style.height = h + "px";
        b.style.opacity = 0.6 + Math.max(0, (height - offset * 4) / maxHeight) * 0.4;
      });
    }

    function renderLoop() {
      if (!isRunning) return;
      const freq = getRoughFrequency();
      if (freq) {
        const info = freqToNoteInfo(freq);
        if (info) {
          noteEl.textContent = info.noteName;
          freqEl.textContent = "Частота: " + freq.toFixed(1) + " Гц";
          // Инструкция по подтяжке: сравнить с целевой нотой. Для простоты ориентируемся на ближайшую ноту
          // Если частота ниже целевой - подтягиваем струну вверх (тон становится выше)
          // Если выше - отпускаем струну
          // Покажем простой текст в status
          statusEl.textContent = "Ближайшая нота: " + info.noteName + " (примерно " + info.freq.toFixed(1) + " Гц)";
        } else {
          freqEl.textContent = "Частота: —";
          noteEl.textContent = "—";
        }
      } else {
        freqEl.textContent = "Частота: —";
        noteEl.textContent = "—";
      }
      updateDiagram(freq);
      requestAnimationFrame(renderLoop);
    }

    startBtn.addEventListener("click", () => {
      startBtn.disabled = true;
      startScanner();
    });
  </script>
</body>
</html>
