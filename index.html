<!DOCTYPE html>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('startButton');
    const statusDiv = document.getElementById('status');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusDiv.innerHTML = `
            <p style="color:red">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.<br>
                –ü–æ–ø—Ä–æ–±—É–π—Ç–µ Chrome, Firefox –∏–ª–∏ Edge.
            </p>`;
        startButton.disabled = true;
        return;
    }

    startButton.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
        } catch (err) {
            if (err.name === 'NotAllowedError') {
                statusDiv.innerHTML = `
                    <p style="color:red">
                        –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â—ë–Ω.<br>
                        1. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.<br>
                        2. –í–∫–ª—é—á–∏—Ç–µ ¬´–ú–∏–∫—Ä–æ—Ñ–æ–Ω¬ª ‚Üí ¬´–†–∞–∑—Ä–µ—à–∏—Ç—å¬ª.<br>
                        3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                    </p>`;
            } else {
                statusDiv.innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞: ${err.message}</p>`;
            }
        }
    });
});
</script>

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û–Ω–ª–∞–π–Ω‚Äë—Ç—é–Ω–µ—Ä –¥–ª—è –≥–∏—Ç–∞—Ä—ã</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f0f0f0;
        }
        #container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        canvas {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #status, #note {
            margin: 10px 0;
            font-size: 18px;
        }
        .tuned {
            color: green;
        }
        .untuned {
            color: red;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>–û–Ω–ª–∞–π–Ω‚Äë—Ç—é–Ω–µ—Ä –¥–ª—è –≥–∏—Ç–∞—Ä—ã</h1>
        <button id="startButton">–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...</div>
        <canvas id="tunerCanvas" width="600" height="200"></canvas>
        <div id="note">–°—Ç—Ä—É–Ω–∞: ‚Äî</div>
    </div>

    <script>
        const canvas = document.getElementById('tunerCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const noteDiv = document.getElementById('note');

        // –≠—Ç–∞–ª–æ–Ω–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å—Ç—Ä—É–Ω –≥–∏—Ç–∞—Ä—ã (—Å—Ç–∞–Ω–¥–∞—Ä—Ç EADGBE)
        const guitarStrings = [
            { name: 'E2', freq: 82.41 },
            { name: 'A2', freq: 110.00 },
            { name: 'D3', freq: 146.83 },
            { name: 'G3', freq: 196.00 },
            { name: 'B3', freq: 246.94 },
            { name: 'E4', freq: 329.63 }
        ];

        let analyser = null;
        let microphone = null;

        // –†–∏—Å—É–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
        function drawTuner(delta) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;

            // –§–æ–Ω
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#f0f0f0';
            ctx.fill();
            ctx.stroke();

            // –°—Ç—Ä–µ–ª–∫–∞
            const arrowLength = radius * 0.8;
            const angle = delta * (Math.PI / 4); // –º–∞–∫—Å. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ¬±45¬∞
            const endX = centerX + arrowLength * Math.sin(angle);
            const endY = centerY - arrowLength * Math.cos(angle);

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(endX, endY);
            ctx.lineWidth = 6;
            ctx.strokeStyle = delta === 0 ? 'green' : 'red';
            ctx.stroke();

            // –¶–µ–Ω—Ç—Ä (—Ç–æ—á–∫–∞)
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();

            // –ü–æ–¥–ø–∏—Å–∏
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = 'gray';
            ctx.fillText('–ù–∏–∂–µ', centerX - radius - 20, centerY + 10);
            ctx.fillText('–í—ã—à–µ', centerX + radius + 20, centerY + 10);
            ctx.fillText('–¢–æ—á–Ω–æ', centerX, centerY + radius + 20);
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–∏–∂–∞–π—à—É—é —Å—Ç—Ä—É–Ω—É –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
        function getClosestString(freq) {
            if (freq < 60 || freq > 400) return null;

            let minDiff = Infinity;
            let bestString = null;

            for (const str of guitarStrings) {
                const diff = Math.abs(freq - str.freq);
                if (diff < minDiff) {
                    minDiff = diff;
                    bestString = str;
                }
            }

            const delta = (freq - bestString.freq) / bestString.freq;
            return { string: bestString, delta: delta };
        }

        // –ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ
        function analyseAudio() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // –ù–∞—Ö–æ–¥–∏–º –ø–∏–∫ —á–∞—Å—Ç–æ—Ç—ã (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
            let maxVal = 0;
            let maxIndex = 0;
            for (let i = 0; i < bufferLength; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }

            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤ —á–∞—Å—Ç–æ—Ç—É
            const sourceSampleRate = 48000; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏
            const binWidth = sourceSampleRate / bufferLength;
            const estimatedFreq = maxIndex * binWidth;

            const result = getClosestString(estimatedFreq);

            if (result) {
                const { string, delta } = result;
                noteDiv.textContent = `–°—Ç—Ä—É–Ω–∞: ${string.name} (${string.freq.toFixed(2)} –ì—Ü)`;
                noteDiv.className = delta === 0 ? 'tuned' : 'untuned';

                // –†–∏—Å—É–µ–º —Å—Ç—Ä–µ–ª–∫—É
                drawTuner(delta);
            } else {
                noteDiv.textContent = '–°—Ç—Ä—É–Ω–∞: ‚Äî';
                noteDiv.className = '';
                drawTuner(0);
            }

            requestAnimationFrame(analyseAudio);
        }

        // –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                microphone.connect(analyser);

                startButton.disabled = true;
                statusDiv.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–µ–Ω. –ò–≥—Ä–∞–π—Ç–µ –Ω–∞ —Å—Ç—Ä—É–Ω–µ...';
                statusDiv.style.color = 'green';

                analyseAudio();
            } catch (err) {
