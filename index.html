<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Онлайн‑тюнер для гитары</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f0f0f0;
        }
        #container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        canvas {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px 0;
            background-color: #f9f9f9;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #status, #note {
            margin: 10px 0;
            font-size: 18px;
        }
        .tuned {
            color: green;
        }
        .untuned {
            color: red;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Онлайн‑тюнер для гитары</h1>
        <button id="startButton">Разрешить микрофон</button>
        <div id="status">Ожидание доступа к микрофону...</div>
        <canvas id="tunerCanvas" width="600" height="200"></canvas>
        <div id="note">Струна: —</div>
    </div>

    <script>
        const canvas = document.getElementById('tunerCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const noteDiv = document.getElementById('note');

        // Эталонные частоты открытых струн гитары (стандарт EADGBE)
        const guitarStrings = [
            { name: 'E2', freq: 82.41 },
            { name: 'A2', freq: 110.00 },
            { name: 'D3', freq: 146.83 },
            { name: 'G3', freq: 196.00 },
            { name: 'B3', freq: 246.94 },
            { name: 'E4', freq: 329.63 }
        ];

        let analyser = null;
        let microphone = null;

        // Рисуем диаграмму
        function drawTuner(delta) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 80;

            // Фон
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#f0f0f0';
            ctx.fill();
            ctx.stroke();

            // Стрелка
            const arrowLength = radius * 0.8;
            const angle = delta * (Math.PI / 4); // макс. отклонение ±45°
            const endX = centerX + arrowLength * Math.sin(angle);
            const endY = centerY - arrowLength * Math.cos(angle);

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(endX, endY);
            ctx.lineWidth = 6;
            ctx.strokeStyle = delta === 0 ? 'green' : 'red';
            ctx.stroke();

            // Центр (точка)
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();

            // Подписи
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = 'gray';
            ctx.fillText('Ниже', centerX - radius - 20, centerY + 10);
            ctx.fillText('Выше', centerX + radius + 20, centerY + 10);
            ctx.fillText('Точно', centerX, centerY + radius + 20);
        }

        // Определяем ближайшую струну и отклонение
        function getClosestString(freq) {
            if (freq < 60 || freq > 400) return null;

            let minDiff = Infinity;
            let bestString = null;

            for (const str of guitarStrings) {
                const diff = Math.abs(freq - str.freq);
                if (diff < minDiff) {
                    minDiff = diff;
                    bestString = str;
                }
            }

            const delta = (freq - bestString.freq) / bestString.freq;
            return { string: bestString, delta: delta };
        }

        // Анализ аудио
        function analyseAudio() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Находим пик частоты (упрощённо)
            let maxVal = 0;
            let maxIndex = 0;
            for (let i = 0; i < bufferLength; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }

            // Переводим индекс в частоту
            const sourceSampleRate = 48000; // примерная частота дискретизации
            const binWidth = sourceSampleRate / bufferLength;
            const estimatedFreq = maxIndex * binWidth;

            const result = getClosestString(estimatedFreq);

            if (result) {
                const { string, delta } = result;
                noteDiv.textContent = `Струна: ${string.name} (${string.freq.toFixed(2)} Гц)`;
                noteDiv.className = delta === 0 ? 'tuned' : 'untuned';

                // Рисуем стрелку
                drawTuner(delta);
            } else {
                noteDiv.textContent = 'Струна: —';
                noteDiv.className = '';
                drawTuner(0);
            }

            requestAnimationFrame(analyseAudio);
        }

        // Запуск микрофона
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                microphone.connect(analyser);

                startButton.disabled = true;
                statusDiv.textContent = 'Микрофон активен. Играйте на струне...';
                statusDiv.style.color = 'green';

                analyseAudio();
            } catch (err) {
